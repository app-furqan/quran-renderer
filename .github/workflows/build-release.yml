name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'dev'

env:
  DEPS_CACHE_KEY: deps-v2

jobs:
  # ==========================================================================
  # Build All Platforms on macOS
  # ==========================================================================
  build-all:
    runs-on: macos-14
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew install ninja python3 cmake

      - name: Setup Android SDK and NDK
        run: |
          # Install Android command line tools
          CMDLINE_TOOLS_URL="https://dl.google.com/android/repository/commandlinetools-mac-11076708_latest.zip"
          mkdir -p ~/android-sdk/cmdline-tools
          curl -L "$CMDLINE_TOOLS_URL" -o cmdline-tools.zip
          unzip -q cmdline-tools.zip -d ~/android-sdk/cmdline-tools
          mv ~/android-sdk/cmdline-tools/cmdline-tools ~/android-sdk/cmdline-tools/latest
          
          # Set environment variables
          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
          echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH

      - name: Accept Android SDK licenses and install NDK
        run: |
          yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager "ndk;28.0.12674087" "platform-tools"
          echo "ANDROID_NDK_HOME=$HOME/android-sdk/ndk/28.0.12674087" >> $GITHUB_ENV

      - name: Cache dependencies (Skia, HarfBuzz, etc.)
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: ../quran-deps
          key: ${{ env.DEPS_CACHE_KEY }}-macos-all-${{ hashFiles('scripts/build-release.sh', 'scripts/build-android-so.sh', 'scripts/build-dependencies.sh') }}
          restore-keys: |
            ${{ env.DEPS_CACHE_KEY }}-macos-all-

      - name: Build Apple libraries (iOS + macOS XCFramework)
        run: |
          chmod +x scripts/build-release.sh
          ./scripts/build-release.sh

      - name: Build Android .so (all ABIs)
        run: |
          chmod +x scripts/build-android-so.sh
          for abi in arm64-v8a armeabi-v7a x86_64; do
            echo "========================================="
            echo "Building Android for $abi..."
            echo "========================================="
            ./scripts/build-android-so.sh --abi $abi
          done

      - name: List build outputs
        run: |
          echo "=== Apple Build ==="
          ls -la build/apple/ || true
          ls -la build/apple/QuranRenderer.xcframework/ || true
          echo "=== Android Build ==="
          ls -la build/android/ || true
          for abi in arm64-v8a armeabi-v7a x86_64; do
            echo "--- $abi ---"
            ls -la build/android/$abi/ || true
          done

      - name: Package unified release
        run: |
          mkdir -p release
          
          # Copy XCFramework
          cp -r build/apple/QuranRenderer.xcframework release/
          
          # Copy individual Apple libs
          mkdir -p release/ios/lib release/ios-simulator/lib release/macos/lib release/macos-dylib
          cp build/apple/ios/lib/libquranrenderer.a release/ios/lib/ 2>/dev/null || true
          cp build/apple/ios-simulator/lib/libquranrenderer.a release/ios-simulator/lib/ 2>/dev/null || true
          cp build/apple/macos/lib/libquranrenderer.a release/macos/lib/ 2>/dev/null || true
          
          # Copy macOS dylib if exists
          if [ -f build/macos-dylib/libquranrenderer.dylib ]; then
            cp build/macos-dylib/libquranrenderer.dylib release/macos-dylib/
          fi
          
          # Copy Android .so files
          mkdir -p release/android
          for abi in arm64-v8a armeabi-v7a x86_64; do
            mkdir -p release/android/$abi
            cp build/android/$abi/libquranrenderer.so release/android/$abi/ 2>/dev/null || true
          done
          
          # Copy headers
          mkdir -p release/include
          cp -r include/quran release/include/
          
          # Copy fonts
          mkdir -p release/fonts
          cp build/apple/fonts/*.otf release/fonts/ 2>/dev/null || true
          cp android/src/main/assets/fonts/*.otf release/fonts/ 2>/dev/null || true
          
          # Create the zip
          cd release
          zip -r ../quran-renderer-release.zip .
          cd ..
          
          echo "=== Release Contents ==="
          unzip -l quran-renderer-release.zip

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: quran-renderer-release
          path: quran-renderer-release.zip
          retention-days: 30

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.version || 'dev' }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Quran Renderer ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'dev') }}
          files: quran-renderer-release.zip
          body: |
            ## Quran Renderer ${{ steps.version.outputs.version }}
            
            Cross-platform Quran text rendering library with HarfBuzz justification and tajweed coloring.
            
            ### Download
            
            ðŸ“¦ **`quran-renderer-release.zip`** - All platforms in one archive
            
            ### Contents
            
            | Platform | Path | Description |
            |----------|------|-------------|
            | **iOS/macOS** | `QuranRenderer.xcframework/` | Universal XCFramework |
            | **iOS Device** | `ios/lib/libquranrenderer.a` | Static library (arm64) |
            | **iOS Simulator** | `ios-simulator/lib/libquranrenderer.a` | Static library (arm64 + x86_64) |
            | **macOS** | `macos/lib/libquranrenderer.a` | Static library (arm64 + x86_64) |
            | **Android arm64** | `android/arm64-v8a/libquranrenderer.so` | Shared library |
            | **Android armv7** | `android/armeabi-v7a/libquranrenderer.so` | Shared library |
            | **Android x86_64** | `android/x86_64/libquranrenderer.so` | Shared library |
            | **Headers** | `include/quran/renderer.h` | C API header |
            | **Fonts** | `fonts/*.otf` | DigitalKhatt Quran fonts |
            
            ### Integration
            
            #### Flutter/Dart FFI
            ```dart
            // Android
            final lib = DynamicLibrary.open('libquranrenderer.so');
            
            // macOS
            final lib = DynamicLibrary.open('libquranrenderer.dylib');
            
            // iOS (statically linked via XCFramework)
            final lib = DynamicLibrary.process();
            ```
            
            #### Swift/Objective-C
            Add `QuranRenderer.xcframework` to your Xcode project.
            
            See [README.md](https://github.com/${{ github.repository }}#usage) for full documentation.
